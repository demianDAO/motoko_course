# Motoko 和 WASM、EVM 的区别和关系

## 关于什么是 Wasm

WebAssembly 或称 wasm 是一个实验性的低级编程语言，应用于浏览器内的客户端。WebAssembly 是便携式的抽象语法树，被设计来提供比 JavaScript 更快速的编译及执行。WebAssembly 将让开发者能运用自己熟悉的编程语言编译，再藉虚拟机引擎在浏览器内执行。

WebAssembly 的主要目标是在网页上启用高性能应用程序，“但它不做任何特定于 Web 的假设或提供特定于 Web 的功能，因此它也可以在其他环境中使用。” 它是一个开放标准，旨在支持任何操作系统上的任何语言，在实践中，所有最流行的语言至少已经获得了一定程度的支持。

WebAssembly 于 2015 年宣布并于 2017 年 3 月首次发布，于 2019 年 12 月 5 日成为万维网联盟推荐并于 2021 年获得 ACM SIGPLAN 的编程语言软件奖。 W3C 在 Mozilla、Microsoft、Google、Apple、Fastly、Intel 和 Red Hat 的贡献下维护该标准.

2015 年首次发布;

2017 年最小可行产品（MVP）的设计宣告完成，预览阶段结束;

2019 年 6 月，Chrome 75 发布，默认启用 WebAssembly 线程;

2022 年 4 月以来，WebAssembly 2.0 处于草案状态，这不是一个重大变化；集成了一些扩展;

## 关于 EVM

EVM 的物理实例化不能用指向云或海浪的相同方式来描述，但它确实作为一个单独的实体存在，由运行以太坊客户端的数千台连接的计算机维护。

以太坊协议本身的存在仅仅是为了保持这个特殊状态机的连续、不间断和不可变的操作。这是所有以太坊账户和智能合约都存在的环境。在链中的任何给定块上，以太坊只有一个“规范”状态，而 EVM 定义了从一个块到另一个块计算新的有效状态的规则。

### 从账本到状态机

“分布式账本”的类比通常用于描述像比特币这样的区块链，它使用密码学的基本工具实现去中心化货币。账本保存了活动记录，该记录必须遵守一组规则，这些规则管理某人可以做什么和不可以做什么来修改账本。例如，一个比特币地址不能花费比它之前收到的更多的比特币。这些规则支撑着比特币和许多其他区块链上的所有交易。

虽然以太坊拥有自己的原生加密货币（以太币），它遵循几乎完全相同的直观规则，但它还支持更强大的功能：智能合约。对于这个更复杂的特征，需要一个更复杂的类比。以太坊不是分布式账本，而是分布式状态机。以太坊的状态是一个庞大的数据结构，它不仅包含所有的账户和余额，而且是一个机器状态，它可以根据预先定义的一组规则在区块之间变化，并且可以执行任意机器代码。从块到块改变状态的具体规则由 EVM 定义。

![](https://ethereum.org/static/e8aca8381c7b3b40c44bf8882d4ab930/302a4/evm.png)

### 以太坊状态转换函数

EVM 的行为就像一个数学函数：给定一个输入，它会产生一个确定性的输出。因此，更正式地将以太坊描述为具有状态转换功能是非常有帮助的：

Y(S, T)= S'

给定一个旧的有效状态(S)和一组新的有效交易(T)，以太坊状态转换函数 Y(S, T)产生一个新的有效输出状态。S'

### 状态

在以太坊的上下文中，状态是一个巨大的数据结构，称为修改后的 Merkle Patricia Trie，它保持所有帐户通过哈希链接，并可简化为存储在区块链上的单个根哈希。

### 交易

交易是来自账户的加密签名指令。有两种类型的交易：导致消息调用的交易和导致合同创建的交易。

合约创建会导致创建一个包含已编译智能合约字节码的新合约账户。每当另一个帐户对该合约进行消息调用时，它都会执行其字节码。

### EVM 指令

![evm](https://ethereum.org/static/9628ab90bfd02f64cf873446cbdc6c70/302a4/gas.png)

通俗讲就是:机器语言!

EVM 作为堆栈机器执行，深度为 1024 项。每个项目都是一个 256 位的字，选择它是为了便于使用 256 位加密。

在执行期间，EVM 维护一个临时内存（作为一个字寻址的字节数组），它不会在事务之间持续存在。

然而，合约确实包含一个 Merkle Patricia 存储树（作为一个字可寻址字数组），与相关帐户和全局状态的一部分相关联。

编译后的智能合约字节码作为一些 EVM 操作码执行，这些操作码执行标准的堆栈操作，例如 XOR、AND、ADD、SUB 等。EVM 还实现了许多区块链特定的堆栈操作，例如 ADDRESS、BALANCE、BLOCKHASH 等。

### EVM 实现

EVM 的所有实现都必须遵守以太坊黄皮书中描述的规范。

在以太坊的 7 年历史中，EVM 经历了多次修订，并且有多种编程语言的 EVM 实现。

- 所有以太坊客户端都包含一个 EVM 实现。此外，还有多个独立的实现，包括：
  - Py-EVM - Python
  - evmone - C++
  - ethereumjs-vm - JavaScript
  - eEVM - C++

其它链互相之间的调用和合约代码的移植都是通过 EVM 进行交互.

## 关于 Motoko

简单讲 Motoko 就是 ic 自己构建的语言,基于 WASM 和 canister!

Motoko 编程语言是一种新型、现代且类型安全的语言，适用于希望构建下一代分布式应用程序以在 Internet 计算机区块链网络上运行的开发人员。Motoko 专门设计用于支持 Internet 计算机的独特功能，并提供熟悉而强大的编程环境。作为一种新语言，Motoko 不断发展，支持新功能和其他改进。

## Motoko(WASM) 与 EVM 的联系

通过桥进行连接,当前迷幻药([psychedelic](https://psychedelic.ooo/))在做这方面的应用,Terabethia.

### 关于 Terabethia

Terabethia 是一种桥接和通信协议，跨链合约（从以太坊和互联网计算机开始）可以用来相互发送消息，以及在 IC 上自动镜像和使用以太坊资产（ERC20、ERC721、ERC1155）。

Terabethia 使用 StarkWare 的消息传递协议，允许以太坊上的任何智能合约或 IC 上的容器向其他网络上的合约发送消息。这样做将扩展以太坊资产的功能和价值，使它们无需修改任何合约或代码即可访问 IC（以及很快其他链）的独特功能！

Terabethia 桥接协议的两个关键方面，一个是 Magic Proxy 代理层 和 Token Factory，使以太坊上的任何人都可以将任何 ERC20、ERC721 和 ERC1155 资产桥接到 IC 并返回消息.

原理是将其锁定在 Magic Proxy 合约上，然后铸币 IC 上等量的包裹 token。该桥将使用等效的 DIP20、DIP721 和 DIP1155 等标准以编程方式为该资产部署一个容器(canister)。

测试应用: [testnet terabethia](https://testnet.terabethia.xyz/)

## 参考

[WebAssembly](https://www.wikiwand.com/en/WebAssembly)

[WebAssembly 中文网](http://webassembly.org.cn/)

[terabethia 桥文档](https://docs.terabethia.ooo/)
